<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Buscar Agendamentos - Auto Wash Car</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/appointments.css') }}">
    <style>
        /* Ajustes para o formul√°rio de busca */
        .search-card {
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 18px;
        }
        .search-row {
            display:flex;
            gap:8px;
            align-items:center;
            justify-content:flex-end;
        }
        input[type="text"].phone-filter {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 260px;
        }
        .btn { 
            background:#007bff; 
            color:#fff; 
            padding:10px 14px; 
            border-radius:8px; 
            text-decoration:none; 
            border:none;
            cursor: pointer;
        }
        .btn:hover {
            background:#0056b3;
        }
        .btn-success {
            background:#28a745;
        }
        .btn-success:hover {
            background:#218838;
        }
        .muted { 
            color: #666; 
            margin-top:6px; 
        }
        .table-wrap { 
            overflow-x:auto; 
        }
        .empty { 
            text-align:center; 
            padding: 20px; 
            color:#444; 
        }
        .highlight-phone {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .highlight-plate {
            background: #d1ecf1;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            color: #0c5460;
        }
        /* mobile */
        @media (max-width:600px){
            .search-row { 
                flex-direction:column; 
                align-items:stretch; 
            }
            input.phone-filter { 
                width:100%; 
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="container">
            {% if logo_url %}
                <img src="{{ logo_url }}" alt="logo" style="height:40px; vertical-align:middle; margin-right:12px;">
            {% endif %}
            <h1 style="display:inline-block; vertical-align:middle; margin:0;">üîç Buscar Agendamentos</h1>

            <nav style="float:right; margin-top:-30px;">
                <a class="btn btn-success" href="{{ url_for('appointments.schedule_appointment') }}">‚ûï Novo Agendamento</a>
            </nav>
        </div>
    </header>

    <main class="container">

        <!-- Mensagens -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="messages">
              {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- CARD DE BUSCA: sempre vis√≠vel -->
        <section class="card search-card">
            <div class="card-header">
                <h2>üì± Buscar por Telefone</h2>
                <p class="muted">Digite o n√∫mero do celular (com DDD) para localizar todos os agendamentos associados.</p>
            </div>

            <div class="card-body">
                <form method="GET" action="{{ url_for('appointments.dashboard') }}">
                    <div class="search-row">
                        <input
                            type="text"
                            id="phone"
                            name="phone"
                            class="phone-filter"
                            placeholder="(99) 99999-9999"
                            maxlength="15"
                            required
                            value="{{ phone_searched or '' }}"
                            aria-label="Celular"
                        >
                        <button class="btn" type="submit">üîé Buscar</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- A TABELA APARECE SOMENTE SE O USU√ÅRIO J√Å BUSCOU PELO TELEFONE -->
        {% if phone_searched %}
            <section class="card">
                <div class="card-header">
                    <h2>üìã Resultado da Busca</h2>
                    <p class="muted">
                        Telefone pesquisado: <span class="highlight-phone">{{ phone_searched }}</span>
                        {% if appointments %}
                            ‚Äî <strong>{{ appointments|length }} agendamento(s) encontrado(s)</strong>
                        {% endif %}
                    </p>
                </div>

                <div class="card-body">
                    {% if appointments %}
                    <div class="table-wrap">
                        <table class="appointments-table" aria-describedby="Lista de agendamentos">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Telefone</th>
                                    <th>Cliente</th>
                                    <th>Placa</th>
                                    <th>Modelo/Tipo</th>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in appointments %}
                                <tr>
                                    <td data-label="ID">{{ a.id }}</td>
                                    <td data-label="Telefone">
                                        <span class="highlight-phone">
                                            {{ a.customer.phone if a.customer else '‚Äî' }}
                                        </span>
                                    </td>
                                    <td data-label="Cliente">
                                        {{ a.customer.name if a.customer else '‚Äî' }}
                                    </td>
                                    <td data-label="Placa">
                                        <span class="highlight-plate">
                                            {{ a.vehicle.plate if a.vehicle else '‚Äî' }}
                                        </span>
                                    </td>
                                    <td data-label="Modelo/Tipo">
                                        {{ a.vehicle.model if a.vehicle and a.vehicle.model else a.vehicle.type if a.vehicle else '‚Äî' }}
                                    </td>
                                    <td data-label="Data">{{ a.date_time.strftime('%d/%m/%Y') }}</td>
                                    <td data-label="Hor√°rio">{{ a.date_time.strftime('%H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="empty">
                            <p>‚ùå Nenhum agendamento encontrado para o telefone <strong>{{ phone_searched }}</strong></p>
                            <p class="muted">Verifique se o n√∫mero est√° correto ou tente novamente.</p>
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}

    </main>

    <footer class="footer">
        <div class="container">
            <small>Auto Wash Car ‚Äî sistema de agendamentos</small>
        </div>
    </footer>

    <!-- M√°scara de celular (vanilla JS) -->
    <script>
    (function(){
        const input = document.getElementById('phone');
        if (!input) return;

        function mascaraCelular(ev){
            let v = ev.target.value.replace(/\D/g,'');
            if (v.length > 11) v = v.slice(0,11);

            if (v.length <= 10) {
                // (99) 9999-9999
                ev.target.value = v
                    .replace(/(\d{2})(\d)/, '($1) $2')
                    .replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                // (99) 99999-9999
                ev.target.value = v
                    .replace(/(\d{2})(\d)/, '($1) $2')
                    .replace(/(\d{5})(\d)/, '$1-$2');
            }
        }

        input.addEventListener('input', mascaraCelular);
        // inicializa se j√° houver valor
        if (input.value) input.dispatchEvent(new Event('input'));
    })();
    </script>
</body>
</html>